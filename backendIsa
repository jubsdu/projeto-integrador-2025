import os
from flask import Flask, request, jsonify
from flask_cors import CORS
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv

# importa os modelos
from Modelo import Medicos, Pacientes, Base

# carrega as variáveis do arquivo .env
load_dotenv()

# cria o app flask
app = Flask(__name__)
# libera o acesso da api para outros sistemas
CORS(app)

# pega o endereço do banco que está no arquivo .env
# exemplo: mssql+pyodbc://usuario:senha@localhost/nomedobanco?driver=ODBC+Driver+17+for+SQL+Server
DATABASE_URL = os.environ["DATABASE_URL"]

# cria a conexão com o banco de dados
engine = create_engine(DATABASE_URL, pool_pre_ping=True, fast_executemany=True)

# cria a sessão para fazer ações no banco
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# rota principal que mostra se o serviço está funcionando
@app.get("/")
def health():
    return {"ok": True, "service": "api-consultas"}, 200


# ----------------- rotas de médicos -----------------
@app.get("/medicos")
def listar_medicos():
    # abre uma sessão no banco
    with SessionLocal() as session:
        # busca todos os médicos
        medicos = session.query(Medicos).all()
        # transforma os dados em uma lista simples
        dados = [
            {
                "id": m.id,
                "nome": m.nome,
                "especialidade": m.especialidade,
                "telefone": m.telefone,
                "email": m.email
            } for m in medicos
        ]
        # devolve os dados no formato json
        return jsonify(dados), 200


@app.post("/medicos")
def criar_medico():
    # pega os dados enviados no corpo da requisição
    data = request.get_json(force=True)

    nome = data.get("nome")
    especialidade = data.get("especialidade")
    telefone = data.get("telefone")
    email = data.get("email")

    # verifica se os campos obrigatórios foram enviados
    if not nome or not especialidade:
        return jsonify({"error": "campos 'nome' e 'especialidade' são obrigatórios"}), 400

    # cria o novo médico e salva no banco
    with SessionLocal() as session:
        novo = Medicos(
            nome=nome,
            especialidade=especialidade,
            telefone=telefone,
            email=email
        )
        session.add(novo)
        session.commit()
        session.refresh(novo)

        # devolve o médico criado como resposta
        return jsonify({
            "id": novo.id,
            "nome": novo.nome,
            "especialidade": novo.especialidade,
            "telefone": novo.telefone,
            "email": novo.email
        }), 201


# ----------------- rotas de pacientes -----------------
@app.get("/pacientes")
def listar_pacientes():
    # abre uma sessão no banco
    with SessionLocal() as session:
        # busca todos os pacientes
        pacientes = session.query(Pacientes).all()
        # transforma os dados em uma lista simples
        dados = [
            {
                "id": p.id,
                "nome": p.nome,
                "data_nascimento": str(p.data_nascimento),
                "telefone": p.telefone,
                "email": p.email
            } for p in pacientes
        ]
        # devolve os dados no formato json
        return jsonify(dados), 200


# executa o servidor flask
if __name__ == "__main__":
    app.run(debug=True)
