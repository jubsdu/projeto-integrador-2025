import os
from flask import Flask, request, jsonify
from flask_cors import CORS
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv

# Importa os modelos
from Modelo import Medicos, Pacientes, Base

# Carrega variáveis do .env
load_dotenv()

app = Flask(__name__)
CORS(app)

# String de conexão do .env (ex.: mssql+pyodbc://sa:SENHA@localhost/EscolaDB?driver=ODBC+Driver+17+for+SQL+Server)
DATABASE_URL = os.environ["DATABASE_URL"]

# Engine para SQL Server
engine = create_engine(DATABASE_URL, pool_pre_ping=True, fast_executemany=True)

# Criação da sessão
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

@app.get("/")
def health():
    return {"ok": True, "service": "api-consultas"}, 200


# ----------------- ROTAS MÉDICOS -----------------
@app.get("/medicos")
def listar_medicos():
    with SessionLocal() as session:
        medicos = session.query(Medicos).all()
        dados = [
            {
                "id": m.id,
                "nome": m.nome,
                "especialidade": m.especialidade,
                "telefone": m.telefone,
                "email": m.email
            } for m in medicos
        ]
        return jsonify(dados), 200


@app.post("/medicos")
def criar_medico():
    data = request.get_json(force=True)

    nome = data.get("nome")
    especialidade = data.get("especialidade")
    telefone = data.get("telefone")
    email = data.get("email")

    if not nome or not especialidade:
        return jsonify({"error": "Campos 'nome' e 'especialidade' são obrigatórios"}), 400

    with SessionLocal() as session:
        novo = Medicos(
            nome=nome,
            especialidade=especialidade,
            telefone=telefone,
            email=email
        )
        session.add(novo)
        session.commit()
        session.refresh(novo)

        return jsonify({
            "id": novo.id,
            "nome": novo.nome,
            "especialidade": novo.especialidade,
            "telefone": novo.telefone,
            "email": novo.email
        }), 201


# ----------------- ROTAS PACIENTES -----------------
@app.get("/pacientes")
def listar_pacientes():
    with SessionLocal() as session:
        pacientes = session.query(Pacientes).all()
        dados = [
            {
                "id": p.id,
                "nome": p.nome,
                "data_nascimento": str(p.data_nascimento),
                "telefone": p.telefone,
                "email": p.email
            } for p in pacientes
        ]
        return jsonify(dados), 200


if __name__ == "__main__":
    app.run(debug=True)
